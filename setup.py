import json
import os
import pathlib
from typing import Callable

from setuptools import setup, Extension
from Cython.Build import cythonize
from pathlib import Path


def get_libraries(library_dirs, prop: Callable[[pathlib.Path], str]):
    libraries = []

    for library_dir in library_dirs:
        libraries.extend([prop(f) for f in library_dir.glob("*.a")])

    return libraries


def main():
    root = Path(os.environ["BLAST_ROOT"])
    release = Path(os.environ["BLAST_RELEASE"])

    include_dirs = [root / "include", root / "inc"]
    library_dirs = [
        release / "lib",
        release / "build" / "corelib",
    ]

    def name(f: pathlib.Path):
        return f.name[3:-2]

    libraries = set(get_libraries(library_dirs, name))

    with open("/home/grihabor/build.log", "w") as build_log:
        json.dump(list(libraries), build_log)

    ordered = [l for l in order if l in libraries]

    extensions = [
        Extension(
            "core",
            ["core.pyx"],
            include_dirs=[str(d) for d in include_dirs],
            language="c++",
            libraries=ordered,
            library_dirs=[str(d) for d in library_dirs],
        )
    ]
    setup(
        name="blastext", ext_modules=cythonize(extensions,), zip_safe=False,
    )


order = ['lmdb', 'blast_app_util', 'xobjsimple', 'id2_split', 'bz2', 'igblast'] +[
  "16S_summaries",
  "Assembly2Fscreen",
  "BlastCgiUtils",
  "BlastOptsTools",
  "BoostTestXML",
  "EntrezCache_cgi",
  "GL",
  "GLU",
  "VDBUtils",
  "Xpm",
  "access",
  "accnmap",
  "ads",
  "agp_db",
  "aligndb_client",
  "alndb_asnclient",
  "alndbaccess",
  "an_core",
  "an_euk_pipeline",
  "an_genbank_pipeline",
  "an_prok_pipeline",
  "an_worker_nodes",
  "asn_config",
  "asn_sample_lib",
  "auxcommcpp_g",
  "auxnet_g",
  "basic_sample_lib",
  "binary_quality_profile",
  "biocollect",
  "biosample",
  "biotree_db",
  "blast_hits_cache",
  "blastdb_format",
  "blastdbinfo",
  "blastinput",
  "blaststoreasncpp_g",
  "bob_g",
  "build_config",
  "cache_g",
  "cluster_assignment",
  "cluster_utils",
  "clustering",
  "cobaltasn_g",
  "connext",
  "ct_ftds100",
  "ct_ftds95",
  "ctransition",
  "ctransition_nlmzip",
  "data_loaders_util",
  "dbapi_sample_base",
  "dbassist_cgi",
  "dbgap_data_access",
  "dbpool",
  "distance",
  "docsum",
  "dtd_sample_lib",
  "edirect",
  "egenedb",
  "egenedomains",
  "eutils",
  "eutilsapp",
  "event_g",
  "featdef",
  "filter_snps",
  "fix_pub",
  "gc_assm_rpt",
  "gc_schedule",
  "gca_sqlite",
  "gcedit",
  "gencoll_load",
  "gene_info_writer",
  "genemark_proc",
  "generic_db_tmpl_utils",
  "genome_size",
  "geodataset",
  "gif",
  "gmap",
  "gnomon_access",
  "gnomon_asn_proc",
  "gp_assm2xml",
  "gpcgi",
  "gpexec_query",
  "gpinit_reports",
  "gpipe_align_format",
  "gpipe_alloc",
  "gpipe_ani",
  "gpipe_best_placement",
  "gpipe_ftp",
  "gpipe_ftp_new",
  "gpipe_kpi",
  "gpipe_meta_access",
  "gpipe_minhash",
  "gpipe_names",
  "gpipe_object_edit",
  "gpipe_prodigal",
  "gpipe_remap",
  "gpipe_standalone",
  "gpipe_teamcity",
  "gpipe_test_boost",
  "gpipe_tree",
  "gpipe_xlsx",
  "gpipe_xml",
  "grpc++",
  "gssapi_krb5",
  "gui_core",
  "guide_tree",
  "gumbelparams",
  "hgvs_name",
  "homologene",
  "htbcli",
  "id2cli",
  "ideochr",
  "ideocli",
  "ideocoord",
  "idgen",
  "idload",
  "insdseq",
  "jiracli",
  "jsd_sample_lib",
  "kmer_metadata",
  "krb5",
  "lbsmdapi",
  "linkos_utils",
  "linkout",
  "linkoutdb",
  "ls_cli",
  "lsh",
  "mapviewcli",
  "mghbn",
  "mim",
  "mlst_best_hits",
  "mmapi",
  "moleblastasn_g",
  "mongocxx",
  "msbuild_dataobj",
  "muscleasn_g",
  "mux_cgi",
  "mv_admincli",
  "mv_cgi",
  "mv_entrezcli",
  "mv_markup",
  "mv_webdata",
  "ncbi",
  "ncbiCacc",
  "ncbiNacc",
  "ncbi_id2proc_cdd",
  "ncbi_id2proc_wgs",
  "ncbi_xblobstorage_netcache",
  "ncbi_xcache_bdb",
  "ncbi_xcache_dbapi",
  "ncbi_xcache_sqlite3",
  "ncbi_xdbapi_ctlib",
  "ncbi_xdbapi_mysql",
  "ncbi_xloader_blastdb_rmt",
  "ncbi_xloader_cdd",
  "ncbi_xloader_genbank",
  "ncbi_xreader_gicache",
  "ncbi_xreader_pubseqos",
  "ncbi_xreader_pubseqos2",
  "ncbicn3dOGL",
  "ncbiid0",
  "ncbiid2",
  "ncbils2_admin",
  "ncbils2_authxml",
  "ncbils2_cli",
  "ncbils2_dispxml",
  "ncbiprs",
  "ncbiprscxx",
  "ncbiprsn",
  "ncbiprsncxx",
  "ncbispel",
  "ncbitax",
  "ncbitxc2cxx",
  "ncbiwww",
  "netstorage",
  "notary",
  "objprt",
  "odbc_ftds100",
  "odbc_ftds95",
  "omssa",
  "osutils",
  "pathogen_cluster_loader",
  "pathogen_fill_taxa",
  "pathogen_target_loader",
  "pcassay",
  "pn_ctl",
  "process_annotation_stats",
  "proj",
  "proteinkmer",
  "protobufd",
  "proxsort",
  "psg_cache",
  "psg_diag",
  "psloader-internal",
  "python_ncbi_dbapi",
  "reftrack_admin",
  "remapcli",
  "sage_mappings",
  "sample_asn",
  "sdbapi",
  "sdncbiauth",
  "seq",
  "seqalign_util",
  "seqentry_comparator",
  "smartasn_g",
  "smartnet",
  "soap_dataobj",
  "spcgi",
  "spellsrvbase",
  "sqlitewrapp",
  "ssparse",
  "sssdb",
  "sybblk64",
  "sybcs64",
  "sybct64",
  "sybdb64",
  "sybdb_ftds100",
  "sybdb_ftds95",
  "sybtcl64",
  "taxon",
  "test_mt",
  "test_stat_ext",
  "tinyseq",
  "tracking_utils",
  "trackmgr_objtools",
  "tvlib",
  "txcscu",
  "unicoll_dump_access",
  "univ_prot_access",
  "validate_regions",
  "validation_details",
  "var_unit_test_lib",
  "varrep",
  "vibnet",
  "w_aln_crossaln",
  "w_aln_multi",
  "w_aln_table",
  "w_edit",
  "w_feat_table",
  "w_hapmap",
  "w_macro_edit",
  "w_seq_desktop",
  "w_seq_text",
  "w_snp_bins",
  "w_snp_ld",
  "w_snp_track",
  "w_snp_utils",
  "w_taxtree",
  "we_cpp",
  "wgmlst_distances",
  "wx_gtk2_aui-3.1",
  "wx_gtk2_core-3.1",
  "wx_gtk2_html-3.1",
  "wx_gtk2_propgrid-3.1",
  "wx_gtk2_qa-3.1",
  "wx_gtk2_richtext-3.1",
  "wx_gtk2_xrc-3.1",
  "xalgocontig_assembly",
  "xalgosegmask",
  "xalgoseqqa",
  "xalgotext",
  "xalgovmerge",
  "xaligncleanup",
  "xaligndb",
  "xalntool",
  "xannot_builder",
  "xasn",
  "xassembly_svc",
  "xbiosample_util",
  "xblastformat",
  "xbma_refiner",
  "xbma_refiner_gui",
  "xcddalignview",
  "xcgi_redirect",
  "xcompress",
  "xconnext",
  "xcser",
  "xctools",
  "xdb",
  "xdiff",
  "xfcgi",
  "xformat",
  "xgpgcreport",
  "xgpp_console_access",
  "xgpsubmit",
  "xgraphiccgi",
  "xgridcgi",
  "xid_estsub",
  "xid_utils_noncorelib",
  "xid_wgs",
  "xmlcgi",
  "xmlreaders",
  "xmyncbi_captcha",
  "xngalign",
  "xobjedit",
  "xobjimport",
  "xobjmanip",
  "xobjmgr",
  "xobjread",
  "xpbacktest",
  "xprimer",
  "xregexp_template_tester",
  "xsd_sample_lib",
  "xslt_xalan",
  "xsoap_server",
  "xstruct_thread",
  "xsubmit2id",
  "xsvdata",
  "xsvlink",
  "xsvnaa",
  "xsvsearchcgi",
  "xunittestutil",
  "xxconnect",
  "fscr1",
  "EntrezCache_g",
  "vdb2blast",
  "bdbasncli",
  "16S_common",
  "gpipe_val",
  "gpipe_fileutils",
  "config_access",
  "taxutl",
  "auxcomm_g",
  "netblast",
  "reftrack_access",
  "build_config_base",
  "cobalt",
  "ncbi_xloader_lds2",
  "dbapi_driver_wrap_s",
  "uilist",
  "esummary",
  "espell",
  "esearch",
  "epost",
  "elink",
  "einfo",
  "ehistory",
  "egquery",
  "ncqhst",
  "eueid",
  "xlinear_prog",
  "monitor_buildrun",
  "tax_xml",
  "refseq_ctl",
  "xrepeatdb",
  "gpipe_xmlutil",
  "prok_cluster_data",
  "gpipe_an_base",
  "test_boost",
  "grpc",
  "w_object_list",
  "w_grid_widget",
  "gui_framework",
  "phytree_format",
  "htbcon",
  "ideo_gridcli",
  "jirasvc",
  "gpipe_kmer_metadata_cache",
  "k5crypto",
  "com_err",
  "objmmail",
  "mongoc-1.0",
  "bsoncxx",
  "generic_db_utils_cgi",
  "mv_admin",
  "netentr",
  "cdd_access",
  "psg_client",
  "ncbi_xreader_id2",
  "ncbi_xreader_id1",
  "ncbi_xreader_cache",
  "eMyNCBI_result",
  "vibrantOGL",
  "ncbicn3d",
  "ncbils2_asn",
  "ncbiindx",
  "ncbiindxcxx",
  "ncbimsc1",
  "ctutils",
  "pathogen_ctl",
  "pcsubstance",
  "gpipe_clean_prot_names",
  "xblast",
  "protobuf-lited",
  "taxoscli",
  "psg_protobuf",
  "psg_cassandra",
  "remap",
  "ncbi_xdbapi_ftds95",
  "ncbi_xdbapi_ftds100",
  "dbapi_util_blobstore",
  "xmyncbi",
  "muxex_g",
  "generic_db_core",
  "sequtil",
  "seqcode",
  "softparse",
  "txserv",
  "ncbitxc2",
  "ncbimla",
  "tds_ftds100",
  "tds_ftds95",
  "sybcomn64",
  "w_phylo_tree",
  "tv_objects",
  "variation_lib",
  "w_hit_matrix",
  "pmcidconv_client",
  "hydra_client",
  "gui_config",
  "w_snp_filter",
  "w_seq_graphic",
  "wgmlst_core",
  "seqtest",
  "prosplign",
  "xgencollstats",
  "blastxml2",
  "blastxml",
  "xstruct_util",
  "xcd_utils",
  "wx_tools",
  "gbseq",
  "gencoll_release_report",
  "xgpp_console_commands",
  "xasmcompare",
  "gui_glmesa",
  "taxon3",
  "seqedit",
  "xlogging",
  "xsoap",
  "xsvcgi",
  "sv_objects",
  "agp_lookup",
  "fbsdstd_g",
  "bdb2ez",
  "muxex-C_g",
  "gpinit_register",
  "gpinit_bag_util",
  "lds2",
  "xportal_auth",
  "gcextract2",
  "validation_results",
  "idload_utils",
  "bacterial_pipeline_proc",
  "attr_cd",
  "grid_wrapper",
  "gpxlib",
  "gpipe_type_verifier",
  "gpipe_sadb",
  "gpipe_jira",
  "gpinit",
  "gpr",
  "cares",
  "boringssl",
  "address_sorting",
  "align_format",
  "htbbase",
  "trackmgrgridcli",
  "ideo",
  "bson-1.0",
  "ncbi_xreader",
  "ncbiacc",
  "ddvlib",
  "ncbils2_cmn",
  "ncbigbcxx",
  "pathogen_connection",
  "gpipe_kmer",
  "xalgodustmask",
  "xalgoblastdbindex",
  "staxupdcmn",
  "ssscli",
  "txclient",
  "rcobaltasn_g",
  "gensvc_g",
  "dbinfoasncpp_g",
  "bl2seqasn_g",
  "alndb_query",
  "dbassist",
  "affy",
  "objtax1",
  "sybunic64",
  "sybintl64",
  "refseq_aln_source",
  "objannotation",
  "intvarutil",
  "annotationproto",
  "w_seq",
  "w_loaders",
  "w_gl",
  "w_aln_score",
  "splines",
  "gui_graph",
  "genesbyloc",
  "wgmlst_store",
  "gencoll_stats",
  "gc_asn_access",
  "xstruct_dp",
  "ncbimime",
  "id1cli",
  "xgpp_console",
  "uudutil",
  "trackmgrcli",
  "ncbi_xloader_wgs",
  "ncbi_xloader_vdbgraph",
  "ncbi_xloader_snp",
  "ncbi_xloader_csra",
  "ncbi_xloader_bam",
  "ncbi_xloader_aligndb",
  "dbldasn_g",
  "bag_access",
  "gpipe_sqlite",
  "pgap_yaml_input_reader",
  "gpipe_asn_proc",
  "gpipe_resource_req",
  "xgp_manifest",
  "gpxapi",
  "xalgowinmask",
  "gpipe_asn_cleanup",
  "gpipe_curl",
  "gpinit_obj",
  "gpinit_access",
  "boringcrypto",
  "gene_info",
  "blast_services",
  "txxmldoc",
  "xmvdatacache",
  "id2",
  "ncbicdr",
  "ncbidesk",
  "gpipe_dateutil",
  "sampling",
  "ssrvcmn",
  "splitdbasncpp_g",
  "dbloadb",
  "xalgoalignsplign",
  "ncbi_xdbapi_ftds",
  "dbapi",
  "objspdi",
  "xid_mapper",
  "ncbi_xloader_asn_cache",
  "spdiproto",
  "w_text_widget",
  "xalgophytree",
  "ncbi_xloader_blastdb",
  "hgvs",
  "xgencoll",
  "simple_asm",
  "gcaccess_utils",
  "cdd",
  "id1",
  "dbsnp_ptis",
  "bamread",
  "aligndb_reader",
  "splitdbasn_g",
  "xmergetree",
  "xalgognomon",
  "gpipe_blast",
  "seqmasks_io",
  "xnetblastcli",
  "mapview",
  "seqsplit",
  "vibrant",
  "ncbimmdb",
  "blastapi",
  "ssssys",
  "tea_crypt",
  "asnmuxdblb",
  "xalgoalignnw",
  "asn_cache",
  "w_data",
  "fastme",
  "objcoords",
  "entrez2cli",
  "seqgapscan",
  "gc_load_utils",
  "cn3d",
  "grpc_integration",
  "gendefasn_g",
  "gpipe_alnutil",
  "xnetblast",
  "mvobjutil",
  "mv_entrez",
  "mapdata",
  "Xext",
  "vibgif",
  "ncbiid1",
  "ncbitool",
  "blast",
  "sssutils",
  "mux",
  "generic_db_asn",
  "dbloadb_asn",
  "bdb",
  "w_feedback",
  "entrez2",
  "gc_utils",
  "gc_organism",
  "mmdb",
  "scoremat",
  "mv_metacli",
  "mv_align",
  "X11",
  "netcli",
  "ncbiobj",
  "composition_adjustment",
  "generic_db_utils",
  "asngendefs",
  "w_wx",
  "gui_objects",
  "gpipe_objutil",
  "gc_common",
  "mv_meta",
  "creaders",
  "gui_print",
  "gui_objutils",
  "xid_wgsdb",
  "writedb",
  "local_taxon",
  "gpipe_attr",
  "mv_types",
  "gui_opengl",
  "xvalidate",
  "xobjwrite",
  "xobjreadex",
  "xhtml",
  "xdiscrepancy",
  "xalgoalignutil",
  "snputil",
  "searchbyrsid",
  "gencoll_client",
  "gbproj",
  "entrezgene",
  "dbsnp_tooltip_service",
  "biotree",
  "xid_utils",
  "seqdb",
  "gpipe_property",
  "ximage",
  "gui_utils",
  "valerr",
  "variation_utils",
  "xcleanup",
  "macro",
  "xqueryparse",
  "xalgoseq",
  "trackmgr",
  "genome_collection",
  "submit",
  "xslt_libxml",
  "dbapi_driver",
  "blastdb",
  "gpipe_common",
  "ncbi_xcache_netcache",
  "variation",
  "valid",
  "mlacli",
  "xalnmgr",
  "taxon1",
  "seqset",
  "xcgi",
  "eutils_client",
  "xconnserv",
  "xregexp",
  "mla",
  "xobjutil",
  "tables",
  "xmlwrapp",
  "xthrserv",
  "pubmed",
  "pub",
  "medlars",
  "xconnect",
  "medline",
  "connssl",
  "connect",
  "biblio",
  "general",
  "xser",
  "xutil",
  "xncbi"
]


main()
